![Sale CI](https://github.com/gregss/clearancesale/actions/workflows/sale.yml/badge.svg)
## Cервис управляющий распродажами в магазине
Cервис в себе хранит информацию о распродажах, через загруженные маркетологом параметры управляет ходом распродажи (фиксирует продажи и предоставляет информацию о доступной остатках)

### Запуск приложения
`make up`

### Архитектура
- postgreSQL
- rpc (twirp)
- rebbitMQ

### Как это работает
Основные свойства распродажи:
- название
- период действия(дата начала, дата окончания)
- стоп фактор (остатки региона, остатки главного распределительного центра, остатки по логистической цепочке)
\* стоп фактор - алгоритмы, определяющие остаток товара на складах в зависимости от типа
- тип контрагента которому доступна распродажа (все, b2b, b2c)
- тип распродажи (параметр, определяющий приоритет распродажи, доступные стопфакторы и доступност для типов контрагентов)
- дополнительные служебные поля (дата изменения и пр.)

Распродажа включает в себя список параметров в разрезе номенклатуры-региона. 

Для каждого товара этой номенклатуры в этом регионе менеджером при старте распродажи загружаются параметры:
- максимальное кол-во товаров(этой номенклатуры в этом регионе) которые можно продать по распродаже
- максимальное кол-во товаров(этой номенклатуры в этом регионе) которые можно купить по распродаже в одном заказе(вроде как защита от посредников)
- цена по распродаже товара(этой номенклатуры в этом регионе)
- флаг выгрузки товаров на яндекс-маркет фиды
- дополнительные параметры

Для каждой номенклатуры-региона после загрузки расчитываются параметры:
- доступное кол-во товаров(этой номенклатуры в этом регионе) на складах(или у поставщика). зависит от стопфактора распродажи
- доступное кол-во товаров(этой номенклатуры в этом регионе) которые можно купить в одном заказе в данный момент времени
- статус (активен/удален)

#### Правила расчета вычисляемых параметров
- статус удален:
  - цена ниже чем закупочная "цена * коэффициент1" (коэффициент вынесен в настройках)
  - цена выше чем "продажная в регионе * коэффициент2" (коэффициент в настройках)
  - цена нулевая
  - товар-номенклатура активна в другой активной на данное время распродаже с более высоким приоритетом
  - так же удаляется номенклатура-регион в другой активной распродаже, если она ниже по приоритету
  - обнулился параметр "доступное кол-во товара этой номенклатуры в этом регионе которое можно купить в одном заказе в данный момент времени"
  - статус активен: в остальных случаях
- доступное кол-во товаров. в зависимости от стопфактора:
  - стопфактор "наличие по логистической цепочке"
    - если к номенклатуре привязан поставщик, то считаем число бесконечным ,иначе считаем по стопфактору "остатки главного регионального центра"
  - стопфактор "остатки главного регионального центра"
    - получаем суммарный остаток всех региональных центров по логистической цепочке включая главный московский склад + всех магазинов в текущем регионе
  - стопфактор "остатки региональных центров"
    - получаем суммарный остаток всех региональных центров по логистической цепочке исключая главный московский склад + всех магазинов в текущем регионе
  - стопфактор "остатки региона"
    - получаем суммарный остаток регионалного центра и всех магазинов в регионе
- доступное кол-во товаров(этой номенклатуры в этом регионе) которые можно купить в одном заказе в данный момент времени
```
мин(
  мин(
    "лимит товаров которые можно продать по распродаже суммарно во всех регионах" - "число проданных товаров"
    "доступное кол-во товаров. в зависимости от стопфактора"
  )
  "лимит товаров которые можно продать в одном заказе"
)
```
- Выход товара из распродажи(удаление) необратимо.

#### API
- Сервис предоставляет публичное апи
  - получения данных по доступной распродаже:
  ```
  curl --location --request POST 'http://localhost:8080/twirp/public.v1.SellingService/Rest' \
  --header 'Content-Type: application/json' \
  --data-raw '{
  "rest": [
    {
      "nomenclature_uuid": "3699fdfa-fa11-4f9c-adfd-4a22e18df890",
      "region_id": 1,
      "order_uuid": "fd349237-e9b4-4aa0-acf3-101ef6b48999"
    }
  ]}'
  ```
  - применение распродажи
  ```
  curl --location --request POST 'http://localhost:8080/twirp/public.v1.SellingService/Sell' \
  --header 'Content-Type: application/json' \
  --data-raw '{
  "sell": [
    {
      "nomenclature_uuid": "fd349237-e9b4-4aa0-acf3-101ef6b4899e",
      "quantity": 7,
      "order_uuid": "fd349237-e9b4-4aa0-acf3-101ef6b48999"
    }
  ]}'
  ```
- Сервис имеет UI api для взаимодействия с фронтом
  - Добавление распродажи
  ```
  curl --location --request POST 'http://localhost:8081/twirp/ui.v1.SaleService/Create' \
  --header 'Content-Type: application/json' \
  --data-raw '{
    "name": "sale2",
    "start_date": "2022-05-01T00:00:00Z",
    "end_date": "2022-06-01T00:00:00Z",
    "stop_factor": 4,
    "contractor_type": 1,
    "type": 1
  }'
  ```
  - Добавление параметров (пока без загрузки файлов)
  ```
  curl --location --request POST 'http://localhost:8081/twirp/ui.v1.SaleService/CreateProducts' \
  --header 'Content-Type: application/json' \
  --data-raw '{
    "sale_id": 1,
    "region_id": [1, 2, 3, 4, 5],
    "sale_products": [
      {
        "nomenclature_uuid": "fd349237-e9b4-4aa0-acf3-101ef6b48000",
        "price": 400,
        "max_count": 10,
        "max_order_count": 5,
        "type": 1,
        "is_feed": true
      },
      {
        "nomenclature_uuid": "fd349237-e9b4-4aa0-acf3-101ef6b48222",
        "price": 600,
        "max_count": 40,
        "max_order_count": 3,
        "type": 0,
        "is_feed": false
      }
    ]
  }'
  ```

#### Особенности реализации
- При загрузке параметров товаров распродажи данные отправляются в очередь(загрузка через файл, распродажи очень большие), консьюмер получает добавляет в бд и делает расчет
- Для получения логистических цепочек используется внешний сервис
- Для получения остатков на складах исползуется внешний сервис
- Для получения офисов используется врешний сервис
- Для получения привязки номенклатуры к поставщику используется внешний сервис
- Сервис в дальнейшем может инициировать выгрузку изменений в другие системы через очередь(например в kafka)

### Требования
- реализованы стратегии стоп-факторов расчета остатков
- реализован калькулятор доступного остатка по распродаже
- реализовано публичное и внутреннее апи
- заполнение распродажи реализовано через очередь
- наличие логгирования
- unit тесты
- сборка через docker(docker-compose) makefile
- линтеры
- конфигурирование

### Упрощения:
заглушки для внешних апи и выгрузки в очереди
без ui, cli
не будут реализованы методы изменения, только добавления
не будут реализованы валидаторы и прочие проверки, только проверка на ошибки
